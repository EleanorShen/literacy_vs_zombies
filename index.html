<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è¯†å­—å¤§æˆ˜åƒµå°¸ - ä¿®å¤ç‰ˆ</title>
    <style>
        :root {
            --lawn-green: #2ecc71;
            --lawn-dark: #27ae60;
            --ui-bg: #8B4513;
            --quiz-bg: #fdf5e6;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            background: #222;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- 1. ä¸Šæ–¹ï¼šæ¸¸æˆåŒº --- */
        #game-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow: hidden;
            background: #333;
            position: relative;
            flex-shrink: 0;
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        #lawn {
            width: 900px;
            height: 500px;
            flex-shrink: 0;
            position: relative;
            background-image:
                linear-gradient(var(--lawn-dark) 2px, transparent 2px),
                linear-gradient(90deg, var(--lawn-dark) 2px, transparent 2px);
            background-size: 100px 100px;
            background-color: var(--lawn-green);
            cursor: crosshair;
            transform-origin: top center;
        }

        .entity {
            position: absolute; width: 80px; height: 80px; display: flex;
            align-items: center; justify-content: center; z-index: 2; pointer-events: none;
            flex-direction: column; justify-content: flex-end; padding-bottom: 5px;
        }
        .entity img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(2px 4px 4px rgba(0,0,0,0.4)); }

        .zombie-accessory {
            position: absolute; top: -15px; left: 20px;
            font-size: 40px; z-index: 5;
            filter: drop-shadow(1px 2px 2px rgba(0,0,0,0.5));
        }

        .hp-bar-bg { position: absolute; top: -10px; width: 60px; height: 6px; background: #555; border-radius: 3px; overflow: hidden; z-index: 10;}
        .hp-bar-fill { height: 100%; width: 100%; transition: width 0.2s; }
        .hp-red { background: #e74c3c; }
        .hp-green { background: #2ecc71; }

        .bullet {
            position: absolute; width: 20px; height: 20px; background: #0f0;
            border-radius: 50%; z-index: 2; box-shadow: 0 0 5px #fff; border: 1px solid #006400;
        }

        #wave-message {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 60px; color: #ff3333; font-weight: bold;
            text-shadow: 3px 3px 0 #000, -1px -1px 0 #000;
            z-index: 50; display: none; pointer-events: none; white-space: nowrap;
            background: rgba(0,0,0,0.6); padding: 20px 40px; border-radius: 10px; border: 4px solid #fff;
        }

        /* --- 2. ä¸­é—´ï¼šé“å…·æ  --- */
        #top-bar {
            background: var(--ui-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 20px;
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 20;
            flex-wrap: wrap;
            gap: 15px;
            border-bottom: 4px solid #5d4037;
            border-top: 2px solid #a1887f;
            flex-shrink: 0;
        }

        .score-box {
            background: rgba(0,0,0,0.3); padding: 6px 12px; border-radius: 5px;
            font-size: 18px; border: 2px solid #ffd700; display: flex; align-items: center; gap: 5px;
        }
        .timer-box { font-size: 16px; color: #ddd; display: flex; align-items: center; gap: 5px; }

        .card {
            width: 55px; height: 65px; background: #eee; border-radius: 5px;
            cursor: pointer; display: flex; flex-direction: column; align-items: center;
            justify-content: center; position: relative; border: 2px solid #444;
            transition: transform 0.1s; overflow: hidden;
        }
        .card.selected { border-color: yellow; box-shadow: 0 0 15px yellow; transform: scale(1.1); }
        .card.disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
        .card-cost { position: absolute; bottom: 2px; right: 2px; font-size: 12px; color: black; font-weight: bold; z-index: 2; text-shadow: 1px 1px 0 #fff;}
        .card img { width: 40px; height: 40px; object-fit: contain; }

        .end-btn {
            background: #c0392b; color: white; border: 2px solid #e74c3c;
            padding: 8px 16px; font-size: 16px; font-weight: bold; border-radius: 8px;
            cursor: pointer; box-shadow: 0 4px 0 #922b21;
        }
        .end-btn:active { transform: translateY(2px); box-shadow: none; }

        .plant-info { font-size: 12px; opacity: 0.8; display: none; }

        /* --- 3. ä¸‹æ–¹ï¼šè¯†å­—æŒ‘æˆ˜åŒº --- */
        #quiz-panel {
            flex: 1;
            background: var(--quiz-bg);
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            padding: 20px 20px 80px 20px;
            box-sizing: border-box;
            gap: 20px;
            position: relative;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            z-index: 5;
        }

        #quiz-panel::before {
            content: ""; position: absolute; top: 0; left: 0; right: 0; height: 10px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.1), transparent);
            pointer-events: none;
        }

        .quiz-group-left { display: flex; flex-direction: column; align-items: flex-start; justify-content: center; width: 180px; }
        .quiz-group-center { display: flex; flex-direction: row; align-items: center; gap: 15px; }
        .quiz-group-right { flex: 1; max-width: 600px; }

        .quiz-type-label { font-size: 16px; color: #888; margin-bottom: 5px; }
        .quiz-title { font-size: 24px; color: #5d4037; font-weight: bold; margin: 0; }
        .feedback-area { font-size: 18px; font-weight: bold; margin-top: 5px; height: 25px; }
        .correct { color: green; }

        .main-display {
            font-size: 60px; color: #d35400; font-weight: bold;
            background: #fff; padding: 5px 20px; border-radius: 15px;
            box-shadow: 0 4px 0 #ddd; min-width: 100px; text-align: center;
            font-family: "KaiTi", "æ¥·ä½“", serif;
        }

        .main-speaker-btn {
            font-size: 35px; cursor: pointer; background: #ffecb3; border: 3px solid #ffa000;
            border-radius: 50%; width: 70px; height: 70px; display: flex;
            align-items: center; justify-content: center; box-shadow: 0 4px 0 #ffa000;
        }
        .main-speaker-btn:active { transform: scale(0.95); box-shadow: none; }

        .options-container { width: 100%; }
        .char-grid, .pinyin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .option-btn-char {
            background: #3498db; color: white; border: none; padding: 0; font-size: 32px;
            border-radius: 10px; cursor: pointer; box-shadow: 0 4px 0 #2980b9;
            font-family: "KaiTi", "æ¥·ä½“", serif; height: 60px;
        }
        .option-btn-char:active { transform: translateY(4px); box-shadow: none; }

        .pinyin-option-row { display: flex; gap: 8px; }
        .option-btn-pinyin {
            flex: 1;
            background: #9b59b6; color: white; border: none; height: 55px; font-size: 24px;
            border-radius: 10px; cursor: pointer; box-shadow: 0 4px 0 #8e44ad; font-weight: bold;
        }

        .small-speaker {
            width: 50px; height: 55px; background: #f1c40f; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 24px; border-bottom: 4px solid #d35400; color: #333;
        }

        #wrong-overlay {
            position: absolute; top:0; left:0; right:0; bottom:0;
            background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center;
            z-index: 100; pointer-events: none; opacity: 0; transition: opacity 0.2s;
        }
        #wrong-mark { font-size: 150px; color: red; font-weight: bold; transform: scale(0.5); transition: transform 0.2s; }
        .show-wrong { opacity: 1 !important; }
        .show-wrong #wrong-mark { transform: scale(1) !important; }

        /* --- Overlay Screen Styles --- */
        .overlay-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95); display: flex; justify-content: center;
            align-items: center; flex-direction: column;
            z-index: 9999;
            color: white; padding: 20px; text-align: center;
        }
        #game-over { display: none; }

        .game-over-title { font-size: 40px; margin-bottom: 20px; font-weight: bold; color: #e74c3c; }
        .game-stats { font-size: 20px; margin-bottom: 20px; color: #f1c40f; }
        .review-box {
            background: rgba(255,255,255,0.1); width: 90%; max-width: 500px;
            border-radius: 10px; padding: 15px; margin-bottom: 20px;
            max-height: 25vh; overflow-y: auto; text-align: center;
        }
        .review-item {
            display: inline-block; background: #eee; color: #333;
            padding: 5px 12px; margin: 5px; border-radius: 15px; font-size: 18px;
            font-family: "KaiTi", "æ¥·ä½“", serif;
        }

        /* æ¨¡å¼é€‰æ‹©æ ·å¼ */
        .mode-selection { margin: 20px 0; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; width: 100%; max-width: 400px; }
        .mode-title { font-size: 18px; margin-bottom: 10px; color: #f1c40f; }
        .mode-options-row { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .mode-checkbox-label {
            display: flex; align-items: center; gap: 8px;
            background: #444; padding: 10px 15px; border-radius: 8px;
            cursor: pointer; border: 2px solid #666; transition: 0.2s;
            user-select: none;
        }
        .mode-checkbox-label input { display: none; }
        .mode-checkbox-label:has(input:checked) {
            background: #2ecc71; border-color: #27ae60; color: #000; font-weight: bold;
        }

        .start-btn {
            font-size: 24px; padding: 15px 40px;
            cursor: pointer; background: #fff; border: none; border-radius: 50px;
            font-weight: bold; color: #333; transition: transform 0.2s; margin-top: 10px;
        }
        .start-btn:hover { transform: scale(1.05); }
        .error-msg { color: #e74c3c; margin-top: 10px; height: 20px; font-weight: bold; display:none;}

        /* --- ğŸ“± ç§»åŠ¨ç«¯é€‚é… CSS --- */
        @media (max-width: 900px) {
            #top-bar { justify-content: space-between; padding: 5px 10px; }
            .score-box { font-size: 16px; padding: 5px 10px; min-width: auto; margin-right: 0; }
            .timer-box { font-size: 14px; margin-right: 0; }
            .plant-info { display: none; }
            .card { width: 50px; height: 60px; margin-right: 5px; }
            .end-btn { width: auto; font-size: 14px; padding: 6px 12px; }

            #quiz-panel {
                flex-direction: column;
                align-items: stretch;
                padding: 10px 10px 100px 10px;
            }
            .quiz-group-left {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }
            .quiz-group-center { width: 100%; justify-content: center; margin-bottom: 10px; }
            .quiz-group-right { width: 100%; max-width: none; }
            .quiz-title { font-size: 20px; }
            .quiz-type-label { font-size: 14px; margin: 0; }
            .feedback-area { margin-top: 0; font-size: 14px; }
            .option-btn-char { height: 60px; font-size: 32px; }
            .option-btn-pinyin { height: 50px; font-size: 24px; }
            .small-speaker { height: 50px; width: 50px; }

            .mode-selection { width: 90%; }
        }
    </style>
</head>
<body>

    <div id="start-overlay" class="overlay-screen">
        <h1>è¯†å­—å¤§æˆ˜åƒµå°¸ (ç§»åŠ¨éŸ³é¢‘ä¿®å¤ç‰ˆ)</h1>
        <p>ğŸ§Ÿ æŠµå¾¡åƒµå°¸ | ğŸ“ è¶£å‘³è¯†å­—</p>

        <div class="mode-selection">
            <div class="mode-title">è¯·é€‰æ‹©æŒ‘æˆ˜é¢˜å‹ (å¯å¤šé€‰):</div>
            <div class="mode-options-row">
                <label class="mode-checkbox-label">
                    <input type="checkbox" id="mode-listen" checked>
                    ğŸ‘‚ å¬éŸ³è¾¨å­—
                </label>
                <label class="mode-checkbox-label">
                    <input type="checkbox" id="mode-read" checked>
                    ğŸ‘ï¸ çœ‹å­—é€‰éŸ³
                </label>
            </div>
        </div>

        <div id="start-error" class="error-msg">è¯·è‡³å°‘é€‰æ‹©ä¸€ç§æ¨¡å¼ï¼</div>
        <button class="start-btn" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
    </div>

    <div id="game-over" class="overlay-screen">
        <div class="game-over-title" id="go-title">æ¸¸æˆç»“æŸ</div>
        <div class="game-stats" id="go-stats">ç­”å¯¹: 0</div>

        <div class="review-box">
            <div style="color: #aaa; font-size: 14px; margin-bottom: 10px;">é”™é¢˜æœ¬</div>
            <div id="go-review-list" style="color: #fff;"></div>
        </div>

        <button class="start-btn" onclick="location.reload()">é‡æ–°æŒ‘æˆ˜</button>
    </div>

    <!-- 1. æ¸¸æˆåŒº -->
    <div id="game-wrapper">
        <div id="wave-message">ğŸ’€ åˆä¸€æ³¢åƒµå°¸æ¥äº†ï¼</div>
        <div id="lawn"></div>
    </div>

    <!-- 2. é“å…·æ  -->
    <div id="top-bar">
        <div style="display:flex; align-items:center;">
            <div class="score-box">â˜€ï¸ <span id="score">0</span></div>
            <div class="timer-box" style="margin-left:10px;">â±ï¸ <span id="game-time">00:00</span></div>
        </div>

        <div style="display:flex; align-items:center;">
            <div class="card" id="card-peashooter" onclick="selectPlant('peashooter', 100)">
                <img src="peashooter.png" alt="Pea" onerror="this.style.display='none';this.parentNode.innerText='ğŸŒ±'">
                <div class="card-cost">100</div>
            </div>
            <span class="plant-info" style="color:white; margin-left:10px;">ä¼¤å®³25 æ”»é€Ÿ1.4s</span>
        </div>

        <button class="end-btn" onclick="handleGameOver('manual')">ğŸ›‘ ç»“æŸ</button>
    </div>

    <!-- 3. è¯†å­—åŒº -->
    <div id="quiz-panel">
        <div id="wrong-overlay"><div id="wrong-mark">âŒ</div></div>

        <div class="quiz-group-left">
            <div>
                <div class="quiz-type-label" id="quiz-mode-label">æ¨¡å¼åŠ è½½ä¸­...</div>
                <div class="quiz-title" id="quiz-title">é¢˜ç›®è¦æ±‚</div>
            </div>
            <div class="feedback-area" id="feedback"></div>
        </div>

        <div class="quiz-group-center">
            <div class="main-display" id="main-display">?</div>
            <div class="main-speaker-btn" id="main-speaker" onclick="speakQuestion()" title="æ’­æ”¾è¯»éŸ³">ğŸ”Š</div>
        </div>

        <div class="quiz-group-right">
            <div class="options-container" id="options-container"></div>
        </div>
    </div>

    <script>
        // --- 1. æ•°æ®é…ç½® ---
        const wordData = [
          {char: 'åŒ…', pinyin: 'bÄo'}, {char: 'å°º', pinyin: 'chÇ'}, {char: 'ä½œ', pinyin: 'zuÃ²'},
{char: 'ä¸š', pinyin: 'yÃ¨'}, {char: 'æœ¬', pinyin: 'bÄ›n'}, {char: 'ç¬”', pinyin: 'bÇ'},
{char: 'åˆ€', pinyin: 'dÄo'}, {char: 'è¯¾', pinyin: 'kÃ¨'}, {char: 'æ—©', pinyin: 'zÇo'},
{char: 'æ ¡', pinyin: 'xiÃ o'}, {char: 'æ˜', pinyin: 'mÃ­ng'}, {char: 'åŠ›', pinyin: 'lÃ¬'},
{char: 'å°˜', pinyin: 'chÃ©n'}, {char: 'ä»', pinyin: 'cÃ³ng'}, {char: 'ä¼—', pinyin: 'zhÃ²ng'},
{char: 'åŒ', pinyin: 'shuÄng'}, {char: 'æœ¨', pinyin: 'mÃ¹'}, {char: 'æ—', pinyin: 'lÃ­n'},
{char: 'æ£®', pinyin: 'sÄ“n'}, {char: 'æ¡', pinyin: 'tiÃ¡o'}, {char: 'å¿ƒ', pinyin: 'xÄ«n'},
{char: 'å‡', pinyin: 'shÄ“ng'}, {char: 'å›½', pinyin: 'guÃ³'}, {char: 'æ——', pinyin: 'qÃ­'},
{char: 'ä¸­', pinyin: 'zhÅng'}, {char: 'çº¢', pinyin: 'hÃ³ng'}, {char: 'æ­Œ', pinyin: 'gÄ“'},
{char: 'èµ·', pinyin: 'qÇ'}, {char: 'ä¹ˆ', pinyin: 'me'}, {char: 'ç¾', pinyin: 'mÄ›i'},
{char: 'ä¸½', pinyin: 'lÃ¬'}, {char: 'ç«‹', pinyin: 'lÃ¬'}, {char: 'åˆ', pinyin: 'wÇ”'},
{char: 'å¤œ', pinyin: 'yÃ¨'}, {char: 'æ˜¨', pinyin: 'zuÃ³'}, {char: 'ä»Š', pinyin: 'jÄ«n'},
{char: 'å¹´', pinyin: 'niÃ¡n'}, {char: 'å½±', pinyin: 'yÇng'}, {char: 'å‰', pinyin: 'qiÃ¡n'},
{char: 'å', pinyin: 'hÃ²u'}, {char: 'é»‘', pinyin: 'hÄ“i'}, {char: 'ç‹—', pinyin: 'gÇ’u'},
{char: 'å·¦', pinyin: 'zuÇ’'}, {char: 'å³', pinyin: 'yÃ²u'}, {char: 'å®ƒ', pinyin: 'tÄ'},{char: 'é‡‡', pinyin: 'cÇi'}, {char: 'è²', pinyin: 'liÃ¡n'},
{char: 'é±¼', pinyin: 'yÃº'}, {char: 'ä¸œ', pinyin: 'dÅng'}, {char: 'è¥¿', pinyin: 'xÄ«'},
{char: 'åŒ—', pinyin: 'bÄ›i'}, {char: 'å°–', pinyin: 'jiÄn'}, {char: 'è¯´', pinyin: 'shuÅ'},
{char: 'æ˜¥', pinyin: 'chÅ«n'}, {char: 'é’', pinyin: 'qÄ«ng'}, {char: 'è›™', pinyin: 'wÄ'},
{char: 'å¤', pinyin: 'xiÃ '}, {char: 'å¼¯', pinyin: 'wÄn'}, {char: 'å°±', pinyin: 'jiÃ¹'},
{char: 'å†¬', pinyin: 'dÅng'}, {char: 'ç”·', pinyin: 'nÃ¡n'}, {char: 'å¥³', pinyin: 'nÇš'},
{char: 'å¼€', pinyin: 'kÄi'}, {char: 'å…³', pinyin: 'guÄn'}, {char: 'æ­£', pinyin: 'zhÃ¨ng'},
{char: 'å', pinyin: 'fÇn'}, {char: 'è¿œ', pinyin: 'yuÇn'}, {char: 'æœ‰', pinyin: 'yÇ’u'},
{char: 'è‰²', pinyin: 'sÃ¨'}, {char: 'è¿‘', pinyin: 'jÃ¬n'}, {char: 'å¬', pinyin: 'tÄ«ng'},
{char: 'æ— ', pinyin: 'wÃº'}, {char: 'å£°', pinyin: 'shÄ“ng'}, {char: 'å»', pinyin: 'qÃ¹'},
{char: 'è¿˜', pinyin: 'hÃ¡i'}, {char: 'æ¥', pinyin: 'lÃ¡i'}, {char: 'å¤š', pinyin: 'duÅ'},
{char: 'å°‘', pinyin: 'shÇo'}, {char: 'é»„', pinyin: 'huÃ¡ng'}, {char: 'ç‰›', pinyin: 'niÃº'},
{char: 'åª', pinyin: 'zhÄ«'}, {char: 'çŒ«', pinyin: 'mÄo'}, {char: 'è¾¹', pinyin: 'biÄn'},
{char: 'é¸­', pinyin: 'yÄ'}, {char: 'æœ', pinyin: 'guÇ’'}, {char: 'è‹¹', pinyin: 'pÃ­ng'},
{char: 'æ', pinyin: 'xÃ¬ng'},
{char: 'æ¡ƒ', pinyin: 'tÃ¡o'}, {char: 'ä¹¦', pinyin: 'shÅ«'}
        ];

        const ZOMBIE_TYPES = {
            NORMAL: { type: 'normal', hp: 150, speed: 0.4, accessory: null, damage: 0.5 },
            CONE:   { type: 'cone',   hp: 400, speed: 0.35, accessory: 'ğŸ”º', damage: 0.8 },
            BUCKET: { type: 'bucket', hp: 900, speed: 0.3,  accessory: 'ğŸª£', damage: 1.0 }
        };

        const state = {
            score: 0,
            selectedPlant: null,
            gridSize: 100,
            rows: 5,
            cols: 9,
            plants: [],
            zombies: [],
            bullets: [],
            isGameOver: false,
            isGameStarted: false,
            startTime: 0,
            lastZombieSpawn: 0,
            waveLevel: 0,
            correctCount: 0,
            wrongAnswers: [],
            gameScale: 1,
            activeModes: ['LISTEN', 'READ']
        };

        const elScore = document.getElementById('score');
        const elTime = document.getElementById('game-time');
        const elLawn = document.getElementById('lawn');
        const elGameWrapper = document.getElementById('game-wrapper');
        const elCardPea = document.getElementById('card-peashooter');
        const elWaveMsg = document.getElementById('wave-message');
        const synth = window.speechSynthesis;

        // è¯†å­—DOM
        const elQuizLabel = document.getElementById('quiz-mode-label');
        const elQuizTitle = document.getElementById('quiz-title');
        const elMainDisplay = document.getElementById('main-display');
        const elMainSpeaker = document.getElementById('main-speaker');
        const elOptionsContainer = document.getElementById('options-container');
        const elFeedback = document.getElementById('feedback');
        const elWrongOverlay = document.getElementById('wrong-overlay');
        const elGameOverPanel = document.getElementById('game-over');
        const elGoTitle = document.getElementById('go-title');
        const elGoStats = document.getElementById('go-stats');
        const elGoReviewList = document.getElementById('go-review-list');

        // --- æ ¸å¿ƒï¼šå±å¹•é€‚é…é€»è¾‘ ---
        function resizeGameWindow() {
            const screenWidth = window.innerWidth;
            const logicalWidth = 900;
            const logicalHeight = 500;
            let scale = screenWidth < logicalWidth ? (screenWidth / logicalWidth) : 1;
            state.gameScale = scale;
            elLawn.style.transform = `scale(${scale})`;
            elGameWrapper.style.height = (logicalHeight * scale) + 'px';
        }

        window.addEventListener('resize', resizeGameWindow);
        window.addEventListener('load', resizeGameWindow);
        document.addEventListener('DOMContentLoaded', resizeGameWindow);
        resizeGameWindow();


        // --- 2. æ¸¸æˆæµç¨‹ ---

        // å…³é”®ä¿®å¤ï¼šæ‰‹æœºæµè§ˆå™¨å¿…é¡»åœ¨ç”¨æˆ·ç‚¹å‡»äº‹ä»¶ä¸­â€œè§£é”â€è¯­éŸ³åˆæˆ
        function unlockAudio() {
            if (!synth) return;
            // æ’­æ”¾ä¸€ä¸ªç©ºå­—ç¬¦æ¥æ¿€æ´»ç§»åŠ¨ç«¯éŸ³é¢‘å¼•æ“
            const u = new SpeechSynthesisUtterance("");
            u.volume = 0;
            synth.speak(u);
        }

        function startGame() {
            // è§£é”éŸ³é¢‘
            unlockAudio();

            // è·å–ç”¨æˆ·é€‰æ‹©çš„æ¨¡å¼
            const useListen = document.getElementById('mode-listen').checked;
            const useRead = document.getElementById('mode-read').checked;
            const errorMsg = document.getElementById('start-error');

            if (!useListen && !useRead) {
                errorMsg.style.display = 'block';
                return;
            }

            // æ›´æ–°çŠ¶æ€
            state.activeModes = [];
            // æ ¹æ®ç”¨æˆ·åé¦ˆï¼Œè¿™é‡Œçš„å†…éƒ¨æ ‡è¯†æ— éœ€å˜åŠ¨ï¼Œæˆ‘ä»¬åœ¨ renderQuiz é‡Œäº’æ¢æ˜¾ç¤ºé€»è¾‘å³å¯
            if (useListen) state.activeModes.push('LISTEN');
            if (useRead) state.activeModes.push('READ');

            errorMsg.style.display = 'none';
            document.getElementById('start-overlay').style.display = 'none';

            state.isGameStarted = true;
            state.startTime = Date.now();
            resizeGameWindow();

            initQuiz();
            updateUI();
            requestAnimationFrame(gameLoop);
        }

        function handleGameOver(reason) {
            if (state.isGameOver) return;
            state.isGameOver = true;
            elGameOverPanel.style.display = 'flex';

            let speakStr = "";
            if (reason === 'zombie') {
                elGoTitle.innerText = "ğŸ§  è„‘å­è¢«åƒæ‰äº†!";
                speakStr += "å“å‘€ï¼Œæ¸¸æˆå¤±è´¥ã€‚";
            } else {
                elGoTitle.innerText = "ğŸ‰ æŒ‘æˆ˜ç»“æŸ";
                elGoTitle.style.color = "#2ecc71";
                speakStr += "æ¸¸æˆç»“æŸã€‚";
            }

            elGoStats.innerText = `æœ¬æ¬¡ç­”å¯¹: ${state.correctCount} é¢˜`;
            speakStr += `ä½ ä¸€å…±ç­”å¯¹äº† ${state.correctCount} é“é¢˜ã€‚`;

            elGoReviewList.innerHTML = '';
            const uniqueWrongs = [];
            const map = new Map();
            for (const item of state.wrongAnswers) {
                if(!map.has(item.char)){
                    map.set(item.char, true);
                    uniqueWrongs.push(item);
                }
            }

            if (uniqueWrongs.length === 0) {
                elGoReviewList.innerHTML = '<div style="color:#aaa; padding:20px;">å¤ªæ£’äº†ï¼æ²¡æœ‰åšé”™ä»»ä½•é¢˜ç›®ï¼</div>';
                speakStr += "å¤ªæ£’äº†ï¼Œä½ æ²¡æœ‰ç­”é”™ä»»ä½•é¢˜ç›®ï¼";
            } else {
                let wrongWordsStr = "";
                uniqueWrongs.forEach(w => {
                    const div = document.createElement('div');
                    div.className = 'review-item';
                    div.innerText = `${w.char} (${w.pinyin})`;
                    elGoReviewList.appendChild(div);
                    wrongWordsStr += w.char + "ï¼Œ";
                });
                speakStr += "ä»¥ä¸‹è¿™äº›å­—ç­”é”™äº†ï¼Œè¯·æ³¨æ„å¤ä¹ ï¼š" + wrongWordsStr;
            }

            setTimeout(() => { speakText(speakStr); }, 500);
        }

        // --- 3. è¯†å­—é€»è¾‘ ---
        let currentQuestion = null;
        let isProcessing = false;

        function initQuiz() { generateQuestion(); }

        function generateQuestion() {
            if (state.isGameOver) return;
            isProcessing = false;

            const modeIndex = Math.floor(Math.random() * state.activeModes.length);
            const mode = state.activeModes[modeIndex];

            const targetIndex = Math.floor(Math.random() * wordData.length);
            const target = wordData[targetIndex];

            let distractors = [];
            while(distractors.length < 3) {
                let r = Math.floor(Math.random() * wordData.length);
                if(r !== targetIndex && !distractors.includes(wordData[r])) distractors.push(wordData[r]);
            }
            let options = [...distractors, target];
            options.sort(() => Math.random() - 0.5);

            currentQuestion = { mode: mode, target: target, options: options };

            renderQuiz();

            // æ¯æ¬¡å‡ºé¢˜å¦‚æœæ¨¡å¼æ˜¯å¬éŸ³ï¼Œæˆ–è€…çœ‹å­—ä½†æƒ³æç¤ºä¸€ä¸‹ï¼Œéƒ½å°è¯•æ’­æ”¾
            if (mode === 'LISTEN') setTimeout(speakQuestion, 500);
        }

        // ä¿®å¤ç‰ˆæ’­æ”¾å‡½æ•°
        function speakText(text) {
            if (!synth) return;
            // æ’­æ”¾å‰å¿…é¡»å…ˆå–æ¶ˆï¼Œé˜²æ­¢é˜Ÿåˆ—å¡æ­»
            synth.cancel();

            const utterThis = new SpeechSynthesisUtterance(text);
            utterThis.lang = 'zh-CN';
            utterThis.rate = 0.8;

            // æŸäº›å®‰å“è®¾å¤‡å¯èƒ½éœ€è¦é‡æ–°è·å– voices
            const voices = synth.getVoices();
            // å°è¯•æ‰¾ä¸­æ–‡è¯­éŸ³
            const zhVoice = voices.find(v => v.lang.includes('zh'));
            if(zhVoice) utterThis.voice = zhVoice;

            synth.speak(utterThis);
        }

        function speakQuestion() {
            if (!currentQuestion || state.isGameOver) return;
            speakText(currentQuestion.target.char);
        }

        function renderQuiz() {
            elOptionsContainer.innerHTML = '';
            elFeedback.innerText = '';
            elFeedback.className = 'feedback-area';

            const q = currentQuestion;

            // --- é€»è¾‘äº’æ¢ä¿®æ”¹å¤„ ---
            // ç”¨æˆ·åé¦ˆï¼šåŸæœ¬çš„å¯¹åº”å…³ç³»åäº†ã€‚
            // ç°åœ¨çš„é€»è¾‘ï¼š
            // LISTEN (å¬éŸ³è¾¨å­—) -> æ˜¾ç¤ºæ‹¼éŸ³/å–‡å­ï¼Œé€‰é¡¹æ˜¯æ±‰å­—ã€‚
            // READ (çœ‹å­—é€‰éŸ³) -> æ˜¾ç¤ºæ±‰å­—ï¼Œé€‰é¡¹æ˜¯æ‹¼éŸ³ã€‚

            if (q.mode === 'LISTEN') {
                // å¬éŸ³è¾¨å­—ï¼šçœ‹åˆ°æ‹¼éŸ³(è¾…åŠ©)ï¼Œå¬åˆ°è¯»éŸ³ï¼Œé€‰æ‹©æ±‰å­—
                elQuizLabel.innerText = "æ¨¡å¼ï¼šğŸ‘‚ å¬éŸ³è¾¨å­—";
                elQuizTitle.innerText = "å¬åˆ°çš„æ˜¯å“ªä¸ªå­—ï¼Ÿ";
                elMainDisplay.innerText = q.target.pinyin; // æ˜¾ç¤ºæ‹¼éŸ³è¾…åŠ©
                elMainSpeaker.style.visibility = 'visible';

                const grid = document.createElement('div');
                grid.className = 'char-grid';
                q.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn-char';
                    btn.innerText = opt.char; // é€‰é¡¹æ˜¯æ±‰å­—
                    btn.onclick = () => checkAnswer(opt);
                    grid.appendChild(btn);
                });
                elOptionsContainer.appendChild(grid);

            } else {
                // çœ‹å­—é€‰éŸ³ï¼šçœ‹åˆ°æ±‰å­—ï¼Œé€‰æ‹©æ‹¼éŸ³
                elQuizLabel.innerText = "æ¨¡å¼ï¼šğŸ‘ï¸ çœ‹å­—é€‰éŸ³";
                elQuizTitle.innerText = "è¿™ä¸ªå­—çš„æ‹¼éŸ³æ˜¯ï¼Ÿ";
                elMainDisplay.innerText = q.target.char; // æ˜¾ç¤ºæ±‰å­—
                elMainSpeaker.style.visibility = 'hidden'; // çœ‹å­—æ¨¡å¼å¯ä»¥ä¸éœ€è¦å¤§å–‡å­ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ä¿ç•™ä½œä¸ºæç¤º

                const grid = document.createElement('div');
                grid.className = 'pinyin-grid';
                q.options.forEach(opt => {
                    const row = document.createElement('div');
                    row.className = 'pinyin-option-row';
                    const btn = document.createElement('button');
                    btn.className = 'option-btn-pinyin';
                    btn.innerText = opt.pinyin; // é€‰é¡¹æ˜¯æ‹¼éŸ³
                    btn.onclick = () => checkAnswer(opt);

                    const spk = document.createElement('div');
                    spk.className = 'small-speaker';
                    spk.innerText = 'ğŸ”Š';
                    spk.onclick = (e) => { e.stopPropagation(); speakText(opt.char); }; // ç‚¹å‡»å°å–‡å­è¯»è¿™ä¸ªé€‰é¡¹çš„éŸ³

                    row.appendChild(btn);
                    row.appendChild(spk);
                    grid.appendChild(row);
                });
                elOptionsContainer.appendChild(grid);
            }
        }

        function checkAnswer(selected) {
            if (isProcessing || state.isGameOver) return;

            if (selected === currentQuestion.target) {
                elFeedback.innerText = "âœ… ç­”å¯¹äº†ï¼";
                elFeedback.className = "feedback-area correct";
                addScore(30);
                state.correctCount++;
                isProcessing = true;
                setTimeout(generateQuestion, 800);
            } else {
                addScore(-10);
                state.wrongAnswers.push(currentQuestion.target);
                showWrongAnimation();
                elFeedback.innerText = "âŒ ä¸å¯¹å“¦ï¼Œå†è¯•ä¸€æ¬¡ï¼";
                elFeedback.style.color = "red";
            }
        }

        function showWrongAnimation() {
            elWrongOverlay.classList.add('show-wrong');
            setTimeout(() => { elWrongOverlay.classList.remove('show-wrong'); }, 600);
        }

        // --- 4. ç»æµä¸æ“ä½œ ---
        function addScore(n) {
            state.score += n;
            if (state.score < 0) state.score = 0;
            updateUI();
        }
        function updateUI() {
            elScore.innerText = state.score;
            if (state.score >= 100) elCardPea.classList.remove('disabled');
            else elCardPea.classList.add('disabled');
        }
        function selectPlant(type, cost) {
            if (state.score < cost) return;
            if (state.selectedPlant && state.selectedPlant.type === type) {
                state.selectedPlant = null;
                elCardPea.classList.remove('selected');
            } else {
                state.selectedPlant = { type, cost };
                elCardPea.classList.add('selected');
            }
        }

        // ç‚¹å‡»é€»è¾‘
        elLawn.addEventListener('click', (e) => {
            if (!state.selectedPlant || state.isGameOver) return;

            const rect = elLawn.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;

            // æ˜ å°„å›é€»è¾‘åæ ‡
            const logicalX = (clickX / rect.width) * 900;
            const logicalY = (clickY / rect.height) * 500;

            const col = Math.floor(logicalX / state.gridSize);
            const row = Math.floor(logicalY / state.gridSize);

            if (col < 0 || col >= state.cols || row < 0 || row >= state.rows) return;

            const exists = state.plants.find(p => p.row === row && p.col === col);
            if (exists) return;

            addScore(-state.selectedPlant.cost);
            createPlant(row, col, state.selectedPlant.type);
            state.selectedPlant = null;
            elCardPea.classList.remove('selected');
        });

        // --- 5. æ¸¸æˆå®ä½“é€»è¾‘ ---
        function createHPBar(colorClass) {
            const bg = document.createElement('div');
            bg.className = 'hp-bar-bg';
            const fill = document.createElement('div');
            fill.className = 'hp-bar-fill ' + colorClass;
            bg.appendChild(fill);
            return { bg, fill };
        }

        function createPlant(row, col, type) {
            const el = document.createElement('div');
            el.className = 'entity plant';
            const hpObj = createHPBar('hp-green');
            el.appendChild(hpObj.bg);

            const img = document.createElement('img');
            img.src = 'peashooter.png';
            img.onerror = () => { img.style.display='none'; el.innerText = 'ğŸŒ±'; }

            el.appendChild(img);
            el.style.left = (col * state.gridSize + 10) + 'px';
            el.style.top = (row * state.gridSize + 10) + 'px';
            elLawn.appendChild(el);
            state.plants.push({ id: Math.random(), row, col, type, el, hpBar: hpObj.fill, maxHp: 100, hp: 100, lastShot: 0 });
        }

        function determineZombieType(elapsedTime) {
            const minutes = elapsedTime / 60000;
            if (minutes >= 4 && Math.random() < 0.4) return ZOMBIE_TYPES.BUCKET;
            if (minutes >= 2 && Math.random() < 0.5) return ZOMBIE_TYPES.CONE;
            return ZOMBIE_TYPES.NORMAL;
        }

        function showWaveMessage(msg) {
            elWaveMsg.innerText = msg;
            elWaveMsg.style.display = 'block';
            setTimeout(() => { elWaveMsg.style.display = 'none'; }, 2000);
        }

        function spawnZombie() {
            if(state.isGameOver) return;
            const row = Math.floor(Math.random() * state.rows);
            const elapsed = Date.now() - state.startTime;
            const typeConfig = determineZombieType(elapsed);
            const el = document.createElement('div');
            el.className = 'entity zombie';
            const hpObj = createHPBar('hp-red');
            el.appendChild(hpObj.bg);

            if (typeConfig.accessory) {
                const acc = document.createElement('div');
                acc.className = 'zombie-accessory';
                acc.innerText = typeConfig.accessory;
                el.appendChild(acc);
            }

            const img = document.createElement('img');
            img.src = 'zombie.png';
            img.onerror = () => { img.style.display='none'; const s = document.createElement('span'); s.innerText='ğŸ§Ÿ'; el.appendChild(s); }

            el.appendChild(img);

            let posX = state.cols * state.gridSize;
            el.style.left = posX + 'px';
            el.style.top = (row * state.gridSize + 10) + 'px';
            elLawn.appendChild(el);
            state.zombies.push({
                id: Math.random(), row: row, x: posX, maxHp: typeConfig.hp, hp: typeConfig.hp,
                speed: typeConfig.speed, damage: typeConfig.damage, el: el, hpBar: hpObj.fill,
                isEating: false, targetPlantId: null
            });
        }

        function fireBullet(plant) {
            const el = document.createElement('div');
            el.className = 'bullet';
            let startX = plant.col * state.gridSize + 60;
            el.style.left = startX + 'px';
            el.style.top = (plant.row * state.gridSize + 40) + 'px';
            elLawn.appendChild(el);
            state.bullets.push({ id: Math.random(), row: plant.row, x: startX, el: el, speed: 5, damage: 25 });
        }

        function gameLoop(timestamp) {
            if (!state.isGameStarted || state.isGameOver) return;
            const elapsed = Date.now() - state.startTime;
            const mins = Math.floor(elapsed / 60000);
            const secs = Math.floor((elapsed % 60000) / 1000);
            elTime.innerText = `${mins.toString().padStart(2,0)}:${secs.toString().padStart(2,0)}`;

            // Wave Logic
            const minVal = elapsed / 60000;
            let currentWave = 0;
            if (minVal >= 4) currentWave = 2;
            else if (minVal >= 2) currentWave = 1;

            if (currentWave > state.waveLevel) {
                state.waveLevel = currentWave;
                showWaveMessage("ğŸ’€ åˆä¸€æ³¢åƒµå°¸æ¥äº†ï¼");
            }

            // Spawn Logic
            let currentSpawnRate = Math.max(1000, 4000 - (elapsed / 1000) * 10);
            if (Date.now() - state.lastZombieSpawn > currentSpawnRate) {
                spawnZombie();
                state.lastZombieSpawn = Date.now();
            }

            // Plants Logic
            state.plants.forEach(plant => {
                const hasTarget = state.zombies.some(z => z.row === plant.row && z.x > plant.col * state.gridSize);
                if (hasTarget && Date.now() - plant.lastShot > 1400) {
                    fireBullet(plant);
                    plant.lastShot = Date.now();
                }
            });

            // Bullets Logic
            for (let i = state.bullets.length - 1; i >= 0; i--) {
                let b = state.bullets[i];
                b.x += b.speed;
                b.el.style.left = b.x + 'px';
                if (b.x > state.cols * state.gridSize) {
                    b.el.remove(); state.bullets.splice(i, 1); continue;
                }
                for (let j = state.zombies.length - 1; j >= 0; j--) {
                    let z = state.zombies[j];
                    if (b.row === z.row && b.x >= z.x + 10 && b.x <= z.x + 60) {
                        z.hp -= b.damage;
                        z.hpBar.style.width = Math.max(0, (z.hp / z.maxHp) * 100) + '%';
                        b.el.remove(); state.bullets.splice(i, 1);
                        if (z.hp <= 0) {
                            z.el.innerHTML = '<span style="font-size:80px">ğŸ’¥</span>';
                            setTimeout(() => z.el.remove(), 200);
                            state.zombies.splice(j, 1);
                        }
                        break;
                    }
                }
            }

            // Zombies Logic
            for (let i = state.zombies.length - 1; i >= 0; i--) {
                let z = state.zombies[i];
                if (z.isEating) {
                    const plant = state.plants.find(p => p.id === z.targetPlantId);
                    if (plant) {
                        plant.hp -= z.damage;
                        plant.hpBar.style.width = Math.max(0, (plant.hp / plant.maxHp) * 100) + '%';
                        if (plant.hp <= 0) {
                            plant.el.remove();
                            state.plants = state.plants.filter(p => p.id !== plant.id);
                            z.isEating = false; z.targetPlantId = null;
                        }
                    } else {
                        z.isEating = false; z.targetPlantId = null;
                    }
                } else {
                    z.x -= z.speed;
                    z.el.style.left = z.x + 'px';
                    const plantInFront = state.plants.find(p => p.row === z.row && Math.abs(z.x - (p.col * state.gridSize + 10)) < 30);
                    if (plantInFront) {
                        z.isEating = true; z.targetPlantId = plantInFront.id;
                    }
                    if (z.x < -40) {
                        handleGameOver('zombie');
                        return;
                    }
                }
            }
            requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>
